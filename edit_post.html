<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="https://drive.google.com/uc?id=1JjQJASrjyNBXSk1rT1O5gfC5ZbrhSOj_">
    <link rel="stylesheet" href="../style.css">
    <title>NoteMe</title>
    <!-- Libraries -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <!-- Include jQuery library -->
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <!-- Include jQuery Cookie Plugin -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
</head>
<body id="body">
    <!-- Top sticky header -->
    <header class="container-fluid text-white sticky-top">
        <nav class="navbar d-flex navbar-expand-sm  justify-content-between">
            <ul class="navbar-nav ">
                <li class="nav-item">
                    <img width="70px" height="30px" loading="lazy" src="https://drive.google.com/uc?id=1A8BymbYGwkFTJeNWDP9-iwmg-VzCF24r" alt="a7a">
                </li>
                <li class="nav-item">
                    <a href="../index.html" style="color: white;text-decoration: none;">
                        <h1>NoteMe</h1>
                    </a>
                </li>
            </ul>
            <!-- Add Post -->
            <ul class="navbar-nav ">
                <li class="nav-item">
                    <a href="makePost.html">
                        <img width="40" loading="lazy" src="https://icon-library.com/images/icon-pen/icon-pen-14.jpg" alt="add post">
                    </a> 
                    <a href="settings.html">
                        <img width="40" src="https://th.bing.com/th/id/R.46661bb1dbe1ecd76f5b8f2afadc2f4c?rik=VQ2DLBEa%2bsZpbA&riu=http%3a%2f%2fwww.pngall.com%2fwp-content%2fuploads%2f4%2fSettings-PNG0.png&ehk=F4H5uhhoRPO6PoS8rDqdxY9UCfuzFFyAB4RkJIkZng8%3d&risl=&pid=ImgRaw&r=0" alt="add post">
                    </a>
                </li>
            </ul>
        </nav>
    </header>
    <!-- Profile Infos -->
    <div>
        <nav class="navbar justify-content-start bg-info">
            <ul class="navbar-nav">
                <li class="nav-item">
                    <img id="profPic" data-toggle="modal" data-target="#changeAvatar" width="150px" height="150px" src="https://www.freeiconspng.com/uploads/account-profile-user-icon--icon-search-engine-10.png" alt="your profile picrure">
                </li>
            </ul>
            <ul class="navbar-nav">
                <li class="nav-item">
                    <h3 class="text-white" id="profName">Your Name</h3>                    
                </li>
            </ul>
        </nav>
    </div>
    <div id="changeAvatar" class="modal fade">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <!-- Modal Header -->
                <div class="modal-header">
                    <h5>Change your avatr picture</h5>
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                </div>
                <!-- Modal Body -->
                <div class="modal-body">
                    <input class="form-control" type="url">
                </div>
                <!-- Modal Footer -->
                <div class="modal-footer">
                    <p>put your favourite picture</p>
                    <button type="button" class="btn btn-primary text-white" data-dismiss="modal">Change</button>
                </div>
            </div>
        </div>  
    </div>
    <div class="container-fluid justify-content-center">
        <div  class="col-sm-6 " align="center" id="mainBody">
            <h1>Edit post</h1>
            <div class="border-top my-3"></div>
            <div id="myPosts">
                    <!-- Your Content here -->
            </div>
        </div>  
        <div class="container-fluid justify-content-start">
            <div class="form-group">
                <input id="newPostHeader" class="form-control" type="text" placeholder="New Header">
            </div>
            <div class="form-group">
                <input id="newPostImg" class="form-control" type="text" placeholder="New Img">
            </div>
            <button id="SaveBtn" class="btn bg-primary text-white">Save</button>
            <button id="DeleteBtn" class="btn border-3 border-danger text-danger">Delete</button>
            <div id="error-301" class="alert alert-danger">
                <a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>
                <strong>Error!</strong> Doing Actio 301!
            </div>
            <div id="success-111" class="alert alert-info">
                <a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>
                <strong>Success!</strong> Saved successfully!
            </div>
            <div id="deleteSoMes" class="alert alert-warning">
                <a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>
                <strong>Alert!</strong> You have deleted the post!
            </div>
        </div>
    </div>
    <script type="module">
        // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.18.0/firebase-app.js";
      import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.18.0/firebase-analytics.js";
      import { getDatabase, ref, onValue, child, get ,set, push, remove, update  } from  "https://www.gstatic.com/firebasejs/9.18.0/firebase-database.js";
       // TODO: Add SDKs for Firebase products that you want to use
        // https://firebase.google.com/docs/web/setup#available-libraries
        
        // Your web app's Firebase configuration
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
            apiKey: "AIzaSyB26LjMWqNXTktoEEfU7qmwfBlK8rVjtHs",
            authDomain: "note-me-chat.firebaseapp.com",
            databaseURL: "https://note-me-chat-default-rtdb.firebaseio.com",
            projectId: "note-me-chat",
            storageBucket: "note-me-chat.appspot.com",
            messagingSenderId: "825913163540",
            appId: "1:825913163540:web:9cbe9b99909ae5f6838c01",
            measurementId: "G-RFGSE7L1MW"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const dbRef = ref(getDatabase());
        const database = getDatabase()
        function IsCookieExist(cookieName) {
            return $.cookie(cookieName) !== undefined;
        }
        
        var uidCookieExists = IsCookieExist('UID');
        const getUIDCookie = $.cookie('UID');
        if (uidCookieExists) {

            //Change User info
            get(child(dbRef, `/Users/${getUIDCookie}`)).then((snapshot) => {
            if (snapshot.exists()) {
                document.getElementById('profName').innerText = snapshot.val().DisName;
                document.getElementById('profPic').src = snapshot.val().ProfPic;
                // console.log(snapshot.val().Name);
                
            } else {
                console.log("No data available");
            }
            }).catch((error) => {
            console.error(error);
            });
        } else {
            document.body.style.overflow = 'hidden';
            let codeSign = `
            <div class="full-screen-overlay">
                <div align="center">
                    <h1>Log in For more fun</h1>
                    <a href="UserInfo/Sign/log-in.html">
                        <button class="btn btn-primary">Log in</button>
                    </a>
                    <a href="UserInfo/Sign/register.html">
                        <button class="btn btn-danger">Register</button>
                    </a>
                </div>
            </div>
        `;
            $(codeSign).appendTo('#body');
        }
    
        //decalre vars
        let profPic = document.getElementById('profPic');
        let profName = document.getElementById('profName');

        //styles
        profPic.style.cursor = 'pointer';
        profPic.style.borderRadius = '50%';
        //decalre var
        
        let newPostHeader = document.getElementById('newPostHeader');
        let newPostImg = document.getElementById('newPostImg');
        let SaveBtn = document.getElementById('SaveBtn');
        let DeleteBtn = document.getElementById('DeleteBtn');

        const getIDparams = new URLSearchParams(window.location.search);
        var userRef = ref(database, `Users/${getUIDCookie}/`); // Replace 'your-node' with the path to your data node
        let Error301 = document.getElementById('error-301');
        let succedMes = document.getElementById('success-111');
        let deleteSoMes = document.getElementById('deleteSoMes');
        $(Error301).hide();
        $(succedMes).hide();
        $(deleteSoMes).hide();
        // Use the get function to retrieve the data
        get(userRef)
        .then((snapshot) => {
            if (snapshot.exists()) {
                // The data exists, and you can access it using snapshot.val()
                var userData = snapshot.val();
                // Now you can use userData for further processing
                var profilePicture = userData.ProfPic;
                
                // Do something with the data...
                } else {
                console.log('No data available');
            }
        })
        .catch((error) => {
            console.error('Error getting data:', error);
        });

        get(child(dbRef, `/Posts/${getUIDCookie}/${getIDparams.get('id')}`)).then((snapshot) => {
        if (snapshot.exists()) {
            let postData = snapshot.val();
            let postHeader = postData.PostHeader;
            let postImg = postData.PostImg;
            let postDate = postData.Date;
    
            let codePost = `
                <nav  class="card  border-top-8">
                    <nav class="navbar ">       
                        <nav class="navbar justify-content-start">                        
                        <ul class="navbar-nav">
                            <li class="nav-item">
                                <img width="40" src="https://www.freeiconspng.com/uploads/account-profile-user-icon--icon-search-engine-10.png" alt="ProgPic">
                            </li>
                        </ul>
                        <ul class="navbar-nav">
                            <li class="nav-item">
                                <h6>${getUIDCookie}</h6>
                            </li>
                        </ul>
                        <ul class="navbar-nav">
                            <li class="nav-item">
                                <p>${postDate}</p>
                            </li>
                        </ul>
                    </nav>
                    
                    <br>
                    <div class="container justify-content-center">
                        <h1>${postHeader}</h1>
                        <img class="thumbnail" width="35%" height="100%" src="${postImg}" alt="Something went wrong..">
                    </div>
                </nav>
                `
                $(codePost).appendTo('#myPosts');
            newPostHeader.value = postHeader;
            newPostImg.value = postImg;
        } else {
            console.log("No data available");
        }
        }).catch((error) => {
        console.error(error);
        });

        const pathToDelete = `/Posts/${getUIDCookie}/${getIDparams.get('id')}`;
        var randomNum = Math.random();
        var numString = randomNum.toString();
        var replaceDot = numString.replace('.','');
        var postId_DEL = parseInt(replaceDot,Math.random()); // article ID
        
        function deletePost(){
            get(child(dbRef, `/Posts/${getUIDCookie}/${getIDparams.get('id')}`)).then((snapshot) => {
                if (snapshot.exists()) {
                    let postData = snapshot.val();
                    let postHeader = postData.PostHeader;
                    set(ref(database, `/Posts/${getUIDCookie}/removed-${getIDparams.get('id')}-${postId_DEL}`), {
                        content: postHeader,
                        delted: true,
                    });
                    // Use the remove method to delete the value
                    const valueRef = ref(database, pathToDelete);
                    remove(valueRef)
                    .then(() => {
                        $(deleteSoMes).show();
                    })
                    .catch((error) => {
                        $(Error301).show();
                        console.error('Error deleting value:', error);
                    });
                    
                } else {
                    console.log("No data available");
                }
            });

        }

        function saveEditedPost(newPostHeader, newPostImg) {
            var userRef = ref(database, `Posts/${getUIDCookie}/${getIDparams.get('id')}`); // Fix: Use ref(database, ...)
            // Update specific value
            var newData = {
                PostHeader: newPostHeader,
                PostImg: newPostImg, // Fix: Use newAvatar instead of newDisplayName
            };

            update(userRef, newData) // Fix: Use update function
                .then(function () {
                    $(succedMes).show();
                })
                .catch(function (error) {
                    $(Error301).show();
                    console.error('Update failed: ', error);
                });
        }

        //set values
        

        SaveBtn.addEventListener('click', function(e){
            e.preventDefault();
            saveEditedPost(newPostHeader.value, newPostImg.value)
        })

        DeleteBtn.addEventListener('click', function(e){
            e.preventDefault();
            deletePost()
        })

    </script>
    
</body>
</html>